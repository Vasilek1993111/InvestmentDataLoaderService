# Ingestion Service

ะกะตัะฒะธั ะดะปั ัะฑะพัะฐ ะธ ััะฐะฝะตะฝะธั ะดะฐะฝะฝัั ะพ ัะธะฝะฐะฝัะพะฒัั ะธะฝััััะผะตะฝัะฐั ัะตัะตะท API ะขะธะฝัะบะพัั ะะฝะฒะตััะธัะธะน.

## ๐ ะะฟะธัะฐะฝะธะต

Ingestion Service - ััะพ Spring Boot ะฟัะธะปะพะถะตะฝะธะต, ะบะพัะพัะพะต ะฐะฒัะพะผะฐัะธัะตัะบะธ ัะพะฑะธัะฐะตั ะดะฐะฝะฝัะต ะพ ัะพััะธะนัะบะธั ะฐะบัะธัั ะธ ััััะตััะฐั ั API ะขะธะฝัะบะพัั ะะฝะฒะตััะธัะธะน ะธ ัะพััะฐะฝัะตั ะธั ะฒ PostgreSQL ะฑะฐะทั ะดะฐะฝะฝัั. ะกะตัะฒะธั ะฟัะตะดะพััะฐะฒะปัะตั REST API ะดะปั ะดะพัััะฟะฐ ะบ ัะพะฑัะฐะฝะฝัะผ ะดะฐะฝะฝัะผ.

### ะัะฝะพะฒะฝัะต ะฒะพะทะผะพะถะฝะพััะธ

- ๐ **ะะฒัะพะผะฐัะธัะตัะบะธะน ัะฑะพั ะดะฐะฝะฝัั** - ะตะถะตะดะฝะตะฒะฝะพะต ะฟะพะปััะตะฝะธะต ัะตะฝ ะทะฐะบัััะธั ะฒ 20:00 ะฟะพ ะะกะ
- ๐ **ะฅัะฐะฝะตะฝะธะต ะธะฝัะพัะผะฐัะธะธ** ะพะฑ ะฐะบัะธัั, ััััะตััะฐั ะธ ะธั ัะตะฝะฐั
- ๐ **REST API** ะดะปั ะดะพัััะฟะฐ ะบ ะดะฐะฝะฝัะผ
- ๐ง **ะะดะผะธะฝะธัััะฐัะธะฒะฝัะต ััะฝะบัะธะธ** ะดะปั ัะฟัะฐะฒะปะตะฝะธั ะดะฐะฝะฝัะผะธ
- โฐ **ะะปะฐะฝะธัะพะฒัะธะบ ะทะฐะดะฐั** ะดะปั ะฐะฒัะพะผะฐัะธะทะฐัะธะธ ะฟัะพัะตััะพะฒ

## ๐๏ธ ะััะธัะตะบัััะฐ

```
โโโโโโโโโโโโโโโโโโโ    โโโโโโโโโโโโโโโโโโโ    โโโโโโโโโโโโโโโโโโโ
โ   REST API      โ    โ  Tinkoff API    โ    โ   PostgreSQL    โ
โ   Controllers   โโโโโบโ   gRPC Client   โโโโโบโ   Database      โ
โโโโโโโโโโโโโโโโโโโ    โโโโโโโโโโโโโโโโโโโ    โโโโโโโโโโโโโโโโโโโ
         โ                       โ                       โ
         โผ                       โผ                       โผ
โโโโโโโโโโโโโโโโโโโ    โโโโโโโโโโโโโโโโโโโ    โโโโโโโโโโโโโโโโโโโ
โ   Services      โ    โ   Scheduler     โ    โ   Repositories  โ
โ   Business      โ    โ   Auto Tasks    โ    โ   Data Access   โ
โ   Logic         โ    โ                 โ    โ                 โ
โโโโโโโโโโโโโโโโโโโ    โโโโโโโโโโโโโโโโโโโ    โโโโโโโโโโโโโโโโโโโ
```

## ๐ ะัััััะน ััะฐัั

### ะัะตะดะฒะฐัะธัะตะปัะฝัะต ััะตะฑะพะฒะฐะฝะธั

- Java 21+
- Maven 3.6+
- PostgreSQL 12+
- ะขะพะบะตะฝ API ะขะธะฝัะบะพัั ะะฝะฒะตััะธัะธะน

### ะฃััะฐะฝะพะฒะบะฐ ะธ ะทะฐะฟััะบ

1. **ะะปะพะฝะธััะนัะต ัะตะฟะพะทะธัะพัะธะน**
   ```bash
   git clone <repository-url>
   cd ingestion-service
   ```

2. **ะะฐัััะพะนัะต ะฑะฐะทั ะดะฐะฝะฝัั**
   ```sql
   CREATE DATABASE postgres;
   CREATE SCHEMA invest;
   ```

3. **ะะฐัััะพะนัะต ะบะพะฝัะธะณััะฐัะธั**
   
   ะััะตะดะฐะบัะธััะนัะต `src/main/resources/application.properties`:
   ```properties
   # ะะฐะผะตะฝะธัะต ะฝะฐ ะฒะฐั ัะพะบะตะฝ ะขะธะฝัะบะพัั API
   tinkoff.api.token=your_tinkoff_token_here
   
   # ะะฐัััะพะนัะต ะฟะพะดะบะปััะตะฝะธะต ะบ ะะ
   spring.datasource.url=jdbc:postgresql://localhost:5434/postgres
   spring.datasource.username=your_username
   spring.datasource.password=your_password
   ```

4. **ะะฐะฟัััะธัะต ะฟัะธะปะพะถะตะฝะธะต**
   ```bash
   mvn spring-boot:run
   ```

5. **ะัะพะฒะตัััะต ัะฐะฑะพัั**
   ```bash
   curl http://localhost:8083/shares
   ```

## ๐ API Endpoints

### ะัะฝะพะฒะฝัะต endpoints

| ะะตัะพะด | Endpoint | ะะฟะธัะฐะฝะธะต |
|-------|----------|----------|
| GET | `/shares` | ะะพะปััะธัั ัะฟะธัะพะบ ะฐะบัะธะน |
| GET | `/futures` | ะะพะปััะธัั ัะฟะธัะพะบ ััััะตััะพะฒ |
| GET | `/close-prices` | ะะพะปััะธัั ัะตะฝั ะทะฐะบัััะธั |
| GET | `/trading-schedules` | ะะพะปััะธัั ัะพัะณะพะฒัะต ัะฐัะฟะธัะฐะฝะธั |
| GET | `/trading-statuses` | ะะพะปััะธัั ััะฐัััั ัะพัะณะพะฒะปะธ |

### ะะดะผะธะฝะธัััะฐัะธะฒะฝัะต endpoints

| ะะตัะพะด | Endpoint | ะะฟะธัะฐะฝะธะต |
|-------|----------|----------|
| POST | `/admin/load-close-prices` | ะะฐะณััะทะธัั ัะตะฝั ะทะฐะบัััะธั ะทะฐ ัะตะณะพะดะฝั |
| POST | `/admin/load-close-prices/{date}` | ะะตัะตะทะฐะณััะทะธัั ัะตะฝั ะทะฐ ัะบะฐะทะฐะฝะฝัั ะดะฐัั |

### ะัะธะผะตัั ะธัะฟะพะปัะทะพะฒะฐะฝะธั

#### ะะพะปััะตะฝะธะต ะฐะบัะธะน
```bash
# ะัะต ะฐะบัะธะธ
curl "http://localhost:8083/shares"

# ะะบัะธะธ ัะพะปัะบะพ ั MOEX
curl "http://localhost:8083/shares?exchange=MOEX"

# ะะบัะธะธ ะฒ ััะฑะปัั
curl "http://localhost:8083/shares?currency=RUB"
```

#### ะะพะปััะตะฝะธะต ัะตะฝ ะทะฐะบัััะธั
```bash
# ะฆะตะฝั ะทะฐะบัััะธั ะดะปั ะบะพะฝะบัะตัะฝัั ะธะฝััััะผะตะฝัะพะฒ
curl "http://localhost:8083/close-prices?instrumentId=BBG000B9XRY4&instrumentId=BBG000B9XRY5"
```

## ๐๏ธ ะกัััะบัััะฐ ะฑะฐะทั ะดะฐะฝะฝัั

### ะขะฐะฑะปะธัั

- `shares` - ะธะฝัะพัะผะฐัะธั ะพะฑ ะฐะบัะธัั
- `futures` - ะธะฝัะพัะผะฐัะธั ะพ ััััะตััะฐั  
- `invest.close_prices` - ัะตะฝั ะทะฐะบัััะธั
- `invest.last_prices` - ะฟะพัะปะตะดะฝะธะต ัะตะฝั

### ะกัะตะผะฐ ะดะฐะฝะฝัั

```sql
-- ะะบัะธะธ
CREATE TABLE shares (
    figi VARCHAR PRIMARY KEY,
    ticker VARCHAR NOT NULL,
    name VARCHAR NOT NULL,
    currency VARCHAR NOT NULL,
    exchange VARCHAR NOT NULL
);

-- ะคัััะตััั
CREATE TABLE futures (
    figi VARCHAR PRIMARY KEY,
    ticker VARCHAR NOT NULL,
    asset_type VARCHAR NOT NULL,
    basic_asset VARCHAR NOT NULL,
    currency VARCHAR NOT NULL,
    exchange VARCHAR NOT NULL,
    stock_ticker VARCHAR
);

-- ะฆะตะฝั ะทะฐะบัััะธั
CREATE TABLE invest.close_prices (
    price_date DATE,
    figi VARCHAR,
    close_price DECIMAL(18,9) NOT NULL,
    instrument_type VARCHAR NOT NULL,
    currency VARCHAR NOT NULL,
    exchange VARCHAR NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    PRIMARY KEY (price_date, figi)
);
```

## โ๏ธ ะะพะฝัะธะณััะฐัะธั

### ะัะฝะพะฒะฝัะต ะฝะฐัััะพะนะบะธ

| ะะฐัะฐะผะตัั | ะะฟะธัะฐะฝะธะต | ะะพ ัะผะพะปัะฐะฝะธั |
|----------|----------|--------------|
| `server.port` | ะะพัั ะฟัะธะปะพะถะตะฝะธั | 8083 |
| `tinkoff.api.token` | ะขะพะบะตะฝ API ะขะธะฝัะบะพัั | - |
| `app.timezone` | ะงะฐัะพะฒะพะน ะฟะพัั | Europe/Moscow |

### ะะปะฐะฝะธัะพะฒัะธะบ ะทะฐะดะฐั

- **ะกะฑะพั ัะตะฝ ะทะฐะบัััะธั**: ะบะฐะถะดัะน ะดะตะฝั ะฒ 20:00 ะฟะพ ะะกะ
- **Cron ะฒััะฐะถะตะฝะธะต**: `0 0 20 * * *`

## ๐ง ะะฐะทัะฐะฑะพัะบะฐ

### ะกัััะบัััะฐ ะฟัะพะตะบัะฐ

```
src/main/java/com/example/ingestionservice/
โโโ config/          # ะะพะฝัะธะณััะฐัะธั
โโโ controller/      # REST ะบะพะฝััะพะปะปะตัั
โโโ dto/            # ะะฑัะตะบัั ะฟะตัะตะดะฐัะธ ะดะฐะฝะฝัั
โโโ entity/         # ะะพะดะตะปะธ ะดะฐะฝะฝัั
โโโ repository/     # ะะตะฟะพะทะธัะพัะธะธ ะดะปั ะดะพัััะฟะฐ ะบ ะะ
โโโ service/        # ะะธะทะฝะตั-ะปะพะณะธะบะฐ
โโโ IngestionServiceApplication.java
```

### ะะฐะฒะธัะธะผะพััะธ

- **Spring Boot 3.5.4** - ะพัะฝะพะฒะฝะพะน ััะตะนะผะฒะพัะบ
- **Spring Data JPA** - ัะฐะฑะพัะฐ ั ะฑะฐะทะพะน ะดะฐะฝะฝัั
- **Tinkoff PI API** - SDK ะดะปั ัะฐะฑะพัั ั API ะขะธะฝัะบะพัั
- **PostgreSQL** - ะฑะฐะทะฐ ะดะฐะฝะฝัั
- **Lombok** - ัะฟัะพัะตะฝะธะต ะบะพะดะฐ

### ะกะฑะพัะบะฐ

```bash
# ะกะฑะพัะบะฐ ะฟัะพะตะบัะฐ
mvn clean compile

# ะะฐะฟััะบ ัะตััะพะฒ
mvn test

# ะกะพะทะดะฐะฝะธะต JAR ัะฐะนะปะฐ
mvn package
```

## ๐ ะฃัััะฐะฝะตะฝะธะต ะฝะตะฟะพะปะฐะดะพะบ

### ะงะฐัััะต ะฟัะพะฑะปะตะผั

1. **ะัะธะฑะบะฐ ะฟะพะดะบะปััะตะฝะธั ะบ ะะ**
   - ะัะพะฒะตัััะต ะฝะฐัััะพะนะบะธ ะฒ `application.properties`
   - ะฃะฑะตะดะธัะตัั, ััะพ PostgreSQL ะทะฐะฟััะตะฝ

2. **ะัะธะฑะบะฐ ะฐะฒัะพัะธะทะฐัะธะธ API ะขะธะฝัะบะพัั**
   - ะัะพะฒะตัััะต ัะพะบะตะฝ ะฒ ะฝะฐัััะพะนะบะฐั
   - ะฃะฑะตะดะธัะตัั, ััะพ ัะพะบะตะฝ ะฐะบัะธะฒะตะฝ

3. **ะัะธะฑะบะธ gRPC**
   - ะัะพะฒะตัััะต ะฒะตััะธะธ ะทะฐะฒะธัะธะผะพััะตะน
   - ะฃะฑะตะดะธัะตัั ะฒ ัะพะฒะผะตััะธะผะพััะธ SDK

### ะะพะณะธ

ะัะธะปะพะถะตะฝะธะต ะธัะฟะพะปัะทัะตั ััะฐะฝะดะฐััะฝะพะต ะปะพะณะธัะพะฒะฐะฝะธะต Spring Boot. ะะพะณะธ ะผะพะถะฝะพ ะฝะฐะนัะธ ะฒ ะบะพะฝัะพะปะธ ะธะปะธ ะฝะฐัััะพะธัั ะฒัะฒะพะด ะฒ ัะฐะนะป.

## ๐ ะะธัะตะฝะทะธั

[ะฃะบะฐะถะธัะต ะปะธัะตะฝะทะธั ะฟัะพะตะบัะฐ]

## ๐ค ะะบะปะฐะด ะฒ ะฟัะพะตะบั

1. ะคะพัะบะฝะธัะต ัะตะฟะพะทะธัะพัะธะน
2. ะกะพะทะดะฐะนัะต ะฒะตัะบั ะดะปั ะฝะพะฒะพะน ััะฝะบัะธะธ
3. ะะฝะตัะธัะต ะธะทะผะตะฝะตะฝะธั
4. ะกะพะทะดะฐะนัะต Pull Request

## ๐ ะะพะดะดะตัะถะบะฐ

ะะปั ะฒะพะฟัะพัะพะฒ ะธ ะฟัะตะดะปะพะถะตะฝะธะน ัะพะทะดะฐะฒะฐะนัะต Issues ะฒ ัะตะฟะพะทะธัะพัะธะธ ะฟัะพะตะบัะฐ.