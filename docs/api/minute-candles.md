# Загрузка минутных свечей

## Обзор

Система использует оптимизированную загрузку минутных свечей в базу данных с параллельной обработкой. Это значительно повышает производительность при обработке большого количества инструментов.

## Новые эндпоинты

### Общие методы

#### POST /api/candles/minute
Загрузка минутных свечей за сегодня

**Запрос:**
```json
{
  "instruments": ["BBG004730N88", "BBG004730ZJ9"],
  "assetType": ["SHARES", "FUTURES"]
}
```

**Ответ:**
```json
{
  "success": true,
  "message": "Загрузка минутных свечей за сегодня запущена",
  "taskId": "uuid-task-id",
  "endpoint": "/api/candles/minute",
  "instruments": ["BBG004730N88", "BBG004730ZJ9"],
  "assetTypes": ["SHARES", "FUTURES"],
  "status": "STARTED",
  "startTime": "2024-01-01T10:00:00Z",
}
```

#### POST /api/candles/minute/{date}
Загрузка минутных свечей за конкретную дату

**Параметры:**
- `date` - дата в формате YYYY-MM-DD

**Запрос и ответ:** аналогично предыдущему методу

### Методы по типам активов

#### POST /api/candles/minute/shares/{date}
Загрузка минутных свечей всех акций за дату

#### POST /api/candles/minute/futures/{date}
Загрузка минутных свечей всех фьючерсов за дату

#### POST /api/candles/minute/indicatives/{date}
Загрузка минутных свечей всех индикативов за дату

## Архитектура обработки

### Пул потоков

Система использует несколько специализированных пулов потоков:

1. **minuteCandleExecutor** - основной пул для обработки инструментов
   - Core: 6-12 потоков (зависит от количества процессоров)
   - Max: 12-24 потока
   - Queue: 1000 задач

2. **apiDataExecutor** - пул для API запросов
   - Core: 4-8 потоков
   - Max: 8-16 потоков
   - Queue: 500 задач

3. **batchWriteExecutor** - пул для пакетной записи в БД
   - Core: 2-4 потока
   - Max: 4-8 потоков
   - Queue: 100 задач

### Алгоритм обработки

1. **Разбиение на батчи**: Инструменты разбиваются на батчи по 10% от общего количества
2. **Обработка батчей**: Каждый батч обрабатывается в отдельном потоке
3. **Обработка инструментов**: Внутри батча инструменты обрабатываются параллельно
4. **Асинхронные API запросы**: Запросы к внешнему API выполняются асинхронно
5. **Пакетная запись в БД**: Свечи сохраняются пакетами для оптимизации производительности

### Преимущества

- **Высокая производительность**: Обработка множества инструментов с оптимизацией
- **Масштабируемость**: Автоматическая настройка пулов потоков под количество процессоров
- **Отказоустойчивость**: Обработка ошибок на уровне отдельных инструментов
- **Мониторинг**: Подробное логирование процесса обработки

### Мониторинг

Все операции логируются в таблицу `system_logs` с детальной информацией:
- Статус обработки каждого инструмента
- Количество обработанных свечей
- Время выполнения операций
- Ошибки и исключения

### Обратная совместимость

Старые эндпоинты остаются доступными:
- `/api/candles/minute` - обычная загрузка
- `/api/candles/minute/{date}` - обычная загрузка за дату
- `/api/candles/minute/shares/{date}` - обычная загрузка акций
- `/api/candles/minute/futures/{date}` - обычная загрузка фьючерсов
- `/api/candles/minute/indicatives/{date}` - обычная загрузка индикативов

## Рекомендации по использованию

1. **Для больших объемов данных** используйте параллельные методы (`/parallel/`)
2. **Для небольших наборов инструментов** можно использовать обычные методы
3. **Мониторинг производительности** через логи системы
4. **Настройка пулов потоков** в зависимости от нагрузки сервера
