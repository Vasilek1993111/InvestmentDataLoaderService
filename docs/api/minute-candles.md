# API минутных свечей

## Обзор

Система предоставляет REST API для работы с минутными свечами, включая загрузку в базу данных с параллельной обработкой и получение данных без сохранения. Все POST методы используют оптимизированную параллельную обработку для максимальной производительности.

## Эндпоинты

### POST методы (загрузка в БД с параллельной обработкой)

#### POST /api/candles/minute
Загрузка минутных свечей за сегодня

**Запрос:**
```json
{
  "instruments": ["BBG004730N88", "BBG004730ZJ9"],
  "assetType": ["SHARES", "FUTURES"],
  "date": "2024-01-01"
}
```

**Ответ:**
```json
{
  "success": true,
  "message": "Загрузка минутных свечей за сегодня запущена",
  "taskId": "uuid-task-id",
  "endpoint": "/api/candles/minute",
  "instruments": ["BBG004730N88", "BBG004730ZJ9"],
  "assetTypes": ["SHARES", "FUTURES"],
  "status": "STARTED",
  "startTime": "2024-01-01T10:00:00Z"
}
```

#### POST /api/candles/minute/{date}
Загрузка минутных свечей за конкретную дату

**Параметры:**
- `date` - дата в формате YYYY-MM-DD

**Запрос и ответ:** аналогично предыдущему методу

#### POST /api/candles/minute/shares/{date}
Загрузка минутных свечей всех акций за дату

**Параметры:**
- `date` - дата в формате YYYY-MM-DD

**Ответ:**
```json
{
  "success": true,
  "message": "Загрузка минутных свечей акций запущена",
  "taskId": "uuid-task-id",
  "endpoint": "/api/candles/minute/shares/2024-01-01",
  "date": "2024-01-01",
  "instrumentsCount": 150,
  "status": "STARTED",
  "startTime": "2024-01-01T10:00:00Z"
}
```

#### POST /api/candles/minute/futures/{date}
Загрузка минутных свечей всех фьючерсов за дату

#### POST /api/candles/minute/indicatives/{date}
Загрузка минутных свечей всех индикативных инструментов за дату

### GET методы (получение данных без сохранения)

#### GET /api/candles/minute/shares/{date}
Получение минутных свечей всех акций за дату

**Параметры:**
- `date` - дата в формате YYYY-MM-DD

**Ответ:**
```json
{
  "date": "2024-01-01",
  "assetType": "SHARES",
  "candles": [
    {
      "figi": "BBG004730N88",
      "ticker": "SBER",
      "name": "Сбербанк",
      "open": 250.50,
      "close": 251.20,
      "high": 251.50,
      "low": 250.30,
      "volume": 1000,
      "time": "2024-01-01T09:00:00Z",
      "isComplete": true,
      "priceChange": 0.70,
      "priceChangePercent": 0.28,
      "candleType": "BULLISH",
      "bodySize": 0.70,
      "upperShadow": 0.30,
      "lowerShadow": 0.20,
      "highLowRange": 1.20,
      "averagePrice": 250.88
    }
  ],
  "totalCandles": 58500,
  "totalInstruments": 150,
  "processedInstruments": 150,
  "successfulInstruments": 145,
  "noDataInstruments": 3,
  "errorInstruments": 2,
  "totalVolume": 58500000,
  "averagePrice": 250.75
}
```

#### GET /api/candles/minute/futures/{date}
Получение минутных свечей всех фьючерсов за дату

#### GET /api/candles/minute/indicatives/{date}
Получение минутных свечей всех индикативных инструментов за дату

## Архитектура обработки

### Пул потоков

Система использует несколько специализированных пулов потоков:

1. **minuteCandleExecutor** - основной пул для обработки инструментов
   - Core: 6-12 потоков (зависит от количества процессоров)
   - Max: 12-24 потока
   - Queue: 1000 задач

2. **apiDataExecutor** - пул для API запросов
   - Core: 4-8 потоков
   - Max: 8-16 потоков
   - Queue: 500 задач

3. **batchWriteExecutor** - пул для пакетной записи в БД
   - Core: 2-4 потока
   - Max: 4-8 потоков
   - Queue: 100 задач

### Алгоритм обработки

1. **Разбиение на батчи**: Инструменты разбиваются на батчи по 10% от общего количества
2. **Обработка батчей**: Каждый батч обрабатывается в отдельном потоке
3. **Обработка инструментов**: Внутри батча инструменты обрабатываются параллельно
4. **Асинхронные API запросы**: Запросы к внешнему API выполняются асинхронно
5. **Пакетная запись в БД**: Свечи сохраняются пакетами для оптимизации производительности

### Преимущества

- **Высокая производительность**: Обработка множества инструментов с оптимизацией
- **Масштабируемость**: Автоматическая настройка пулов потоков под количество процессоров
- **Отказоустойчивость**: Обработка ошибок на уровне отдельных инструментов
- **Мониторинг**: Подробное логирование процесса обработки

### Мониторинг

Все операции логируются в таблицу `system_logs` с детальной информацией:
- Статус обработки каждого инструмента
- Количество обработанных свечей
- Время выполнения операций
- Ошибки и исключения

### Примеры использования

```bash
# Загрузка минутных свечей за сегодня
curl -X POST http://localhost:8080/api/candles/minute \
  -H "Content-Type: application/json" \
  -d '{"assetType": ["SHARES", "FUTURES"]}'

# Загрузка минутных свечей акций за конкретную дату
curl -X POST http://localhost:8080/api/candles/minute/shares/2024-01-01

# Получение минутных свечей акций за дату
curl -X GET http://localhost:8080/api/candles/minute/shares/2024-01-01

# Загрузка минутных свечей фьючерсов
curl -X POST http://localhost:8080/api/candles/minute/futures/2024-01-01

# Загрузка минутных свечей индикативов
curl -X POST http://localhost:8080/api/candles/minute/indicatives/2024-01-01
```

### Коды ответов

- **200 OK** - Успешное получение данных (GET методы)
- **202 Accepted** - Загрузка запущена (POST методы)
- **400 Bad Request** - Неверные параметры запроса
- **500 Internal Server Error** - Внутренняя ошибка сервера

### Обработка ошибок

Все ошибки логируются и возвращаются в стандартном формате:

```json
{
  "success": false,
  "message": "Ошибка запуска загрузки: [описание ошибки]",
  "taskId": "uuid-task-id",
  "status": "ERROR"
}
```