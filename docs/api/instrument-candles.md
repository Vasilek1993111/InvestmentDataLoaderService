# API свечей инструментов

## Обзор

Система предоставляет REST API для работы со свечами конкретных инструментов, включая загрузку в базу данных с параллельной обработкой и получение данных без сохранения. Все POST методы используют оптимизированную параллельную обработку для максимальной производительности.

## Эндпоинты

### Минутные свечи

#### GET /api/candles/instrument/minute/{figi}/{date}
Получение минутных свечей конкретного инструмента за дату без сохранения

**Параметры:**
- `figi` - идентификатор инструмента
- `date` - дата в формате YYYY-MM-DD

**Ответ:**
```json
{
  "figi": "BBG004730N88",
  "date": "2024-01-01",
  "candles": [
    {
      "figi": "BBG004730N88",
      "ticker": "SBER",
      "name": "Сбербанк",
      "time": "2024-01-01T09:00:00Z",
      "open": 250.50,
      "close": 251.20,
      "high": 251.50,
      "low": 250.30,
      "volume": 1000,
      "isComplete": true,
      "priceChange": 0.70,
      "priceChangePercent": 0.28,
      "candleType": "BULLISH",
      "bodySize": 0.70,
      "upperShadow": 0.30,
      "lowerShadow": 0.20,
      "highLowRange": 1.20,
      "averagePrice": 250.88
    }
  ],
  "totalCandles": 390,
  "totalVolume": 390000,
  "averagePrice": 250.75
}
```

#### POST /api/candles/instrument/minute/{figi}/{date}
Загрузка минутных свечей конкретного инструмента за дату

**Параметры:**
- `figi` - идентификатор инструмента
- `date` - дата в формате YYYY-MM-DD

**Ответ:**
```json
{
  "success": true,
  "message": "Сохранение минутных свечей инструмента BBG004730N88 за 2024-01-01 запущено",
  "taskId": "uuid-task-id",
  "endpoint": "/api/candles/instrument/minute/BBG004730N88/2024-01-01",
  "figi": "BBG004730N88",
  "date": "2024-01-01",
  "status": "STARTED",
  "startTime": "2024-01-01T10:00:00Z"
}
```

### Дневные свечи

#### GET /api/candles/instrument/daily/{figi}/{date}
Получение дневных свечей конкретного инструмента за дату без сохранения

**Параметры:**
- `figi` - идентификатор инструмента
- `date` - дата в формате YYYY-MM-DD

**Ответ:**
```json
{
  "figi": "BBG004730N88",
  "date": "2024-01-01",
  "candles": [
    {
      "figi": "BBG004730N88",
      "ticker": null,
      "name": null,
      "time": "2024-01-01T00:00:00Z",
      "open": 250.50,
      "close": 255.30,
      "high": 256.00,
      "low": 249.80,
      "volume": 1000000,
      "isComplete": true,
      "priceChange": 4.80,
      "priceChangePercent": 1.92,
      "candleType": "BULLISH",
      "bodySize": 4.80,
      "upperShadow": 0.70,
      "lowerShadow": 0.70,
      "highLowRange": 6.20,
      "averagePrice": 252.90
    }
  ],
  "totalCandles": 1,
  "totalVolume": 1000000,
  "averagePrice": 252.90
}
```

#### POST /api/candles/instrument/daily/{figi}/{date}
Загрузка дневных свечей конкретного инструмента за дату

**Параметры:**
- `figi` - идентификатор инструмента
- `date` - дата в формате YYYY-MM-DD

**Ответ:**
```json
{
  "success": true,
  "message": "Сохранение дневных свечей инструмента BBG004730N88 за 2024-01-01 запущено",
  "taskId": "uuid-task-id",
  "endpoint": "/api/candles/instrument/daily/BBG004730N88/2024-01-01",
  "figi": "BBG004730N88",
  "date": "2024-01-01",
  "status": "STARTED",
  "startTime": "2024-01-01T10:00:00Z"
}
```

## Архитектура обработки

### Параллельная обработка

Все POST методы используют оптимизированную параллельную обработку:

1. **Минутные свечи** - используют `MinuteCandleService` с пулами потоков:
   - `minuteCandleExecutor` - основной пул для обработки инструментов
   - `apiDataExecutor` - пул для API запросов
   - `batchWriteExecutor` - пул для пакетной записи в БД

2. **Дневные свечи** - используют `DailyCandleService` с пулами потоков:
   - `dailyCandleExecutor` - основной пул для обработки инструментов
   - `dailyApiDataExecutor` - пул для API запросов
   - `dailyBatchWriteExecutor` - пул для пакетной записи в БД

### Алгоритм обработки

1. **Валидация параметров**: Проверка FIGI и даты
2. **Создание запроса**: Формирование DTO для сервиса
3. **Параллельная загрузка**: Асинхронная обработка через специализированные сервисы
4. **Логирование**: Детальное логирование всех операций
5. **Возврат результата**: Немедленный возврат taskId без ожидания завершения

### Преимущества

- **Высокая производительность**: Параллельная обработка инструментов
- **Масштабируемость**: Автоматическая настройка пулов потоков
- **Отказоустойчивость**: Обработка ошибок на уровне инструментов
- **Мониторинг**: Подробное логирование процесса обработки
- **Гибкость**: Поддержка как минутных, так и дневных свечей

### Мониторинг

Все операции логируются в таблицу `system_logs` с детальной информацией:
- Статус обработки каждого инструмента
- Количество обработанных свечей
- Время выполнения операций
- Ошибки и исключения

### Примеры использования

```bash
# Получение минутных свечей инструмента
curl -X GET http://localhost:8080/api/candles/instrument/minute/BBG004730N88/2024-01-01

# Загрузка минутных свечей инструмента
curl -X POST http://localhost:8080/api/candles/instrument/minute/BBG004730N88/2024-01-01

# Получение дневных свечей инструмента
curl -X GET http://localhost:8080/api/candles/instrument/daily/BBG004730N88/2024-01-01

# Загрузка дневных свечей инструмента
curl -X POST http://localhost:8080/api/candles/instrument/daily/BBG004730N88/2024-01-01
```

### Коды ответов

- **200 OK** - Успешное получение данных (GET методы)
- **202 Accepted** - Загрузка запущена (POST методы)
- **400 Bad Request** - Неверные параметры запроса
- **500 Internal Server Error** - Внутренняя ошибка сервера

### Обработка ошибок

Все ошибки логируются и возвращаются в стандартном формате:

```json
{
  "success": false,
  "message": "Ошибка запуска загрузки: [описание ошибки]",
  "taskId": "uuid-task-id",
  "figi": "BBG004730N88",
  "date": "2024-01-01",
  "status": "ERROR"
}
```
