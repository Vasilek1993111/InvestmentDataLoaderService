# Планировщики (Schedulers)

## Обзор

Система использует Spring Scheduler для автоматической загрузки данных в фоновом режиме. Все планировщики работают с оптимизированными сервисами, использующими параллельную обработку.

## Основные планировщики

### 1. CandleSchedulerService
**Расписание**: `0 10 1 * * *` (1:10 по московскому времени)
- **Функция**: `fetchAndStoreCandles()`
- **Описание**: Автоматически загружает минутные и дневные свечи за предыдущий день
- **Типы активов**: SHARES, FUTURES, INDICATIVES

### 2. MorningSessionScheduler
**Расписание**: `0 50 1 * * *` (1:50 по московскому времени)
- **Функция**: `fetchAndStoreMorningSessionPrices()`
- **Описание**: Загружает цены открытия утренней сессии за предыдущий день
- **Дополнительные расписания**:
  - Выходные дни: `0 1 2 * * 0,6` (2:01)
  - Рабочие дни: `0 1 7 * * 1-5` (7:01), `0 1 9 * * 1-5` (9:01), `0 1 10 * * 1-5` (10:01)

### 3. EveningSessionSchedulerService
**Расписание**: `0 40 1 * * *` (1:40 по московскому времени)
- **Функция**: `fetchAndStoreEveningSessionPrices()`
- **Описание**: Загружает цены закрытия вечерней сессии за предыдущий день
- **Типы активов**: SHARES, FUTURES, INDICATIVES

### 4. VolumeAggregationSchedulerService
**Расписание**: `0 0 2 * * *` (2:00 по московскому времени)
- **Функция**: `fullRefreshVolumeAggregation()`
- **Описание**: Обновляет материализованное представление агрегации объемов
- **Операция**: `REFRESH MATERIALIZED VIEW invest.daily_volume_aggregation`

### 5. ClosePriceSchedulerService
**Расписание**: `0 30 1 * * *` (1:30 по московскому времени)
- **Функция**: `fetchAndStoreClosePrices()`
- **Описание**: Загружает цены закрытия за предыдущий день

### 6. LastTradesSchedulerService
**Расписание**: `0 0 1 * * *` (1:00 по московскому времени)
- **Функция**: `fetchAndStoreLastTrades()`
- **Описание**: Загружает последние сделки за предыдущий день

### 7. InstrumentPreloadSchedulerService
**Расписание**: `0 45 0 * * *` (0:45 по московскому времени)
- **Функция**: `preloadAndPersistInstruments()`
- **Описание**: Предзагружает список инструментов

### 8. AssetFundamentalsSchedulerService
**Расписание**: `0 0 3 * * *` (3:00 по московскому времени)
- **Функция**: `updateAssetFundamentals()`
- **Описание**: Автоматически обновляет фундаментальные показатели всех акций
- **Особенности**: Использует батчинг по 100 активов, принудительное обновление существующих записей

### 9. DividendSchedulerService
**Расписание**: `0 50 0 * * *` (0:50 по московскому времени)
- **Функция**: `fetchAndStoreDividends()`
- **Описание**: Загружает дивиденды по всем акциям за период 2024-2026
- **Типы активов**: SHARES

## Расписание выполнения

| Время (МСК) | Планировщик | Описание |
|-------------|-------------|----------|
| 00:45 | InstrumentPreloadSchedulerService | Предзагрузка инструментов |
| 00:50 | DividendSchedulerService | Загрузка дивидендов по всем акциям |
| 01:00 | LastTradesSchedulerService | Загрузка последних сделок |
| 01:30 | ClosePriceSchedulerService | Загрузка цен закрытия |
| 01:40 | EveningSessionSchedulerService | Загрузка цен закрытия вечерней сессии |
| 01:50 | MorningSessionScheduler | Загрузка цен открытия утренней сессии |
| 02:00 | VolumeAggregationSchedulerService | Обновление агрегации объемов |

## Технические особенности

### Используемые сервисы
- **MinuteCandleService** - для загрузки минутных свечей
- **DailyCandleService** - для загрузки дневных свечей
- **MorningSessionService** - для загрузки цен открытия
- **LastTradesService** - для загрузки последних сделок
- **InstrumentService** - для работы с инструментами
- **DividendService** - для загрузки дивидендов

### Логирование
Все операции планировщиков логируются в консоль:
- Начало и завершение операций
- Время выполнения
- Статус выполнения
- Детальная информация о процессе
- Уникальные taskId для отслеживания

### Обработка ошибок
Каждый планировщик включает комплексную обработку ошибок:
- Логирование всех исключений
- Продолжение работы при ошибках в отдельных операциях
- Детальная информация об ошибках в логах
- Graceful degradation при проблемах с внешними сервисами

### Проверка выходных дней
Планировщики автоматически проверяют, является ли предыдущий день выходным:
- Пропускают выполнение в выходные дни (где применимо)
- Логируют причину пропуска
- Обрабатывают только рабочие дни

## Мониторинг

Для мониторинга работы планировщиков используйте логи приложения:

```bash
# Поиск по taskId
grep "MORNING_" logs/application.log
grep "DIVIDEND_" logs/application.log

# Статистика выполнения
grep "=== ЗАВЕРШЕНИЕ" logs/application.log

# Ошибки планировщиков
grep "Критическая ошибка" logs/application.log
```

## Настройка расписания

Для изменения расписания отредактируйте аннотацию `@Scheduled`:

```java
// Примеры расписаний:
@Scheduled(cron = "0 0 2 * * *", zone = "Europe/Moscow")  // Каждый день в 2:00
@Scheduled(cron = "0 1 7 * * 1-5", zone = "Europe/Moscow") // Рабочие дни в 7:01
@Scheduled(cron = "0 1 2 * * 0,6", zone = "Europe/Moscow") // Выходные в 2:01
```

## API для ручного управления

### VolumeAggregationController
- `POST /api/volume-aggregation/refresh` - ручное обновление агрегации объемов

### SystemController
- `GET /api/system/health` - проверка здоровья системы
- `GET /api/system/diagnostics` - диагностика системы
- `GET /api/system/stats` - статистика системы