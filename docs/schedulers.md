# Планировщики (Schedulers)

## Обзор

Система использует Spring Scheduler для автоматической загрузки свечей в фоновом режиме. Все планировщики работают с оптимизированными сервисами, использующими параллельную обработку.

## CandleSchedulerService

### Основной планировщик

#### Ежедневная загрузка свечей
- **Расписание**: `0 10 1 * * *` (1:10 по московскому времени)
- **Функция**: `fetchAndStoreCandles()`
- **Описание**: Автоматически загружает минутные и дневные свечи за предыдущий день

**Алгоритм работы:**
1. Загружает минутные свечи для всех типов активов (SHARES, FUTURES, INDICATIVES)
2. Пауза 10 секунд
3. Загружает дневные свечи для всех типов активов
4. Логирует начало и завершение операций

### Ручные методы

#### Полная загрузка свечей
```java
public void fetchAndStoreCandlesForDate(LocalDate date)
```
- Загружает и минутные, и дневные свечи за указанную дату
- Использует параллельную обработку через `MinuteCandleService` и `DailyCandleService`

#### Загрузка только минутных свечей
```java
public void fetchAndStoreMinuteCandlesForDate(LocalDate date)
```
- Загружает только минутные свечи за указанную дату
- Использует `MinuteCandleService` с параллельной обработкой

#### Загрузка только дневных свечей
```java
public void fetchAndStoreDailyCandlesForDate(LocalDate date)
```
- Загружает только дневные свечи за указанную дату
- Использует `DailyCandleService` с параллельной обработкой

## Технические особенности

### Используемые сервисы
- **MinuteCandleService** - для загрузки минутных свечей с параллельной обработкой
- **DailyCandleService** - для загрузки дневных свечей с параллельной обработкой
- **SystemLogRepository** - для логирования операций

### DTO для запросов
- **MinuteCandleRequestDto** - для запросов минутных свечей
- **DailyCandleRequestDto** - для запросов дневных свечей

### Логирование
Все операции планировщика логируются в таблицу `system_logs`:
- Начало и завершение операций
- Время выполнения
- Статус выполнения
- Детальная информация о процессе

### Преимущества обновленного планировщика

1. **Параллельная обработка**: Использует оптимизированные сервисы с многопоточностью
2. **Универсальность**: Загружает все типы активов одновременно
3. **Мониторинг**: Подробное логирование всех операций
4. **Гибкость**: Отдельные методы для разных типов свечей
5. **Надежность**: Обработка ошибок на всех уровнях

### Примеры использования

```java
// Автоматический запуск в 1:10 каждый день
// Загружает минутные и дневные свечи за предыдущий день

// Ручная загрузка за конкретную дату
scheduler.fetchAndStoreCandlesForDate(LocalDate.of(2024, 1, 15));

// Загрузка только минутных свечей
scheduler.fetchAndStoreMinuteCandlesForDate(LocalDate.of(2024, 1, 15));

// Загрузка только дневных свечей
scheduler.fetchAndStoreDailyCandlesForDate(LocalDate.of(2024, 1, 15));
```

### Мониторинг

Для мониторинга работы планировщика используйте запросы к таблице `system_logs`:

```sql
-- Последние операции планировщика
SELECT * FROM system_logs 
WHERE endpoint = '/scheduler/candles' 
ORDER BY start_time DESC 
LIMIT 10;

-- Статистика по времени выполнения
SELECT 
    status,
    COUNT(*) as count,
    AVG(duration_ms) as avg_duration_ms,
    MAX(duration_ms) as max_duration_ms
FROM system_logs 
WHERE endpoint = '/scheduler/candles' 
GROUP BY status;
```

### Настройка расписания

Для изменения расписания отредактируйте аннотацию `@Scheduled`:

```java
// Текущее расписание: каждый день в 1:10 по Москве
@Scheduled(cron = "0 10 1 * * *", zone = "Europe/Moscow")

// Примеры других расписаний:
// Каждый час: "0 0 * * * *"
// Каждые 30 минут: "0 */30 * * * *"
// Только в рабочие дни в 2:00: "0 0 2 * * MON-FRI"
```

### Обработка ошибок

Планировщик включает комплексную обработку ошибок:
- Логирование всех исключений
- Продолжение работы при ошибках в отдельных операциях
- Детальная информация об ошибках в логах
- Graceful degradation при проблемах с внешними сервисами